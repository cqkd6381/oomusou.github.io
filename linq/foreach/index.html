<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Refactoring to LINQ =&gt; ForEach | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="以重構角度探討 LINQ">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="以重構角度探討 LINQ">
<meta property="og:type" content="article">
<meta property="og:title" content="Refactoring to LINQ => ForEach">
<meta property="og:url" content="https://oomusou.io/linq/foreach/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="以重構角度探討 LINQ">
<meta property="og:image" content="https://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2018-08-04T11:34:25.640Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Refactoring to LINQ => ForEach">
<meta name="twitter:description" content="以重構角度探討 LINQ">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> Refactoring to LINQ =&gt; ForEach</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 以重構角度探討 LINQ			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#User_Story"><span class="toc-article-text">User Story</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Imperative_:_for"><span class="toc-article-text">Imperative : for</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Imperative_:_foreach"><span class="toc-article-text">Imperative : foreach</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#FP_:_Higher_Order_Function"><span class="toc-article-text">FP : Higher Order Function</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#IEnumrable"><span class="toc-article-text">IEnumrable</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Method_Group"><span class="toc-article-text">Method Group</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Using_static"><span class="toc-article-text">Using static</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#LINQ_:_ForEach"><span class="toc-article-text">LINQ : ForEach</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#LINQ_如何實踐_?"><span class="toc-article-text">LINQ 如何實踐 ?</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#使用時機"><span class="toc-article-text">使用時機</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Reference"><span class="toc-article-text">Reference</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>LINQ 是 C# 3 實現 FP 重要里程碑，提供大量的 Operator，讓我們以 Pure Function 將 data 以 Dataflow 與 Pipeline 方式實現。本系列將先以 Imperative 實作，然後再重構成 FP，最後再重構成 LINQ Operator，並參考 LINQ source code 的實現方式。</p>
<p>首先從最基本的 <code>ForEach</code> Operator 談起。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS High Sierra 10.13.6<br>.NET Core 2.1<br>C# 7.2<br>Rider 2018.1.4</p>
<h2 id="User_Story">User Story</h2><hr>
<p>在 List 中有一堆名字，想要在 console 顯示每個名字。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> names = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Ben"</span>,</span><br><span class="line">                <span class="string">"Jafar"</span>,</span><br><span class="line">                <span class="string">"Matt"</span>,</span><br><span class="line">                <span class="string">"Priya"</span>,</span><br><span class="line">                <span class="string">"Brian"</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Imperative_:_for">Imperative : for</h2><hr>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> names = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Ben"</span>,</span><br><span class="line">                <span class="string">"Jafar"</span>,</span><br><span class="line">                <span class="string">"Matt"</span>,</span><br><span class="line">                <span class="string">"Priya"</span>,</span><br><span class="line">                <span class="string">"Brian"</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> counter = <span class="number">0</span>; counter &lt; names.Count; counter++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(names[counter]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>19 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> counter = <span class="number">0</span>; counter &lt; names.Count; counter++)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(names[counter]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最直覺的方式 (其實應該說被制約的方式)， 就是透過 List 的 Indexer 將 List 的 item 取出來，並透過 <code>for</code> loop 去執行 <code>Console.WriteLine()</code>。</p>
<h2 id="Imperative_:_foreach">Imperative : foreach</h2><hr>
<p><img src="/images/linq/foreach/foreach000.png" alt="foreach000"></p>
<p>此時 Rider 已經提出警告，建議改用 <code>foreach</code></p>
<p><img src="/images/linq/foreach/foreach001.png" alt="foreach001"></p>
<ol>
<li>按熱鍵 <code>⌥ + ↩</code>，選擇 <code>Convert to foreach</code></li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> names = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Ben"</span>,</span><br><span class="line">                <span class="string">"Jafar"</span>,</span><br><span class="line">                <span class="string">"Matt"</span>,</span><br><span class="line">                <span class="string">"Priya"</span>,</span><br><span class="line">                <span class="string">"Brian"</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>19 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重構成 <code>foreach</code> 後，就不必使用 <code>counter</code> 變數，也不用考慮 <code>counter++</code> 寫錯，<code>for</code> loop 的 counter 控制，是常見的 bug 來源，所以重構成 <code>foreach</code> 絕對比 <code>for</code> 來得好。</p>
<p>且 <code>foreach</code> 的語意也比 <code>for</code> 清楚 ，因為不用看到 counter 實作細節。</p>
<h2 id="FP_:_Higher_Order_Function">FP : Higher Order Function</h2><hr>
<p>實務上這種 <code>foreach</code> 天天都要用到，但用 <code>foreach</code> 這種 statement 寫法，重複使用能力為 0，就每天都要不斷的寫 <code>foreach</code>。</p>
<p>若我們能將 <code>foreach</code> 抽成 <code>ForEach()</code> Higher Order Function，我們就能不斷 reuse <code>ForEach()</code>，只要將不同的商業邏輯以 function 傳進 <code>ForEach()</code> 即可。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> names = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Ben"</span>,</span><br><span class="line">                <span class="string">"Jafar"</span>,</span><br><span class="line">                <span class="string">"Matt"</span>,</span><br><span class="line">                <span class="string">"Priya"</span>,</span><br><span class="line">                <span class="string">"Brian"</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            names.MyForEach(name =&gt; Console.WriteLine(name));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> MyForEach&lt;T&gt;(<span class="keyword">this</span> List&lt;T&gt; list, Action&lt;T&gt; action)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> iter <span class="keyword">in</span> list)</span><br><span class="line">            &#123;</span><br><span class="line">                action(iter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>22 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> MyForEach&lt;T&gt;(<span class="keyword">this</span> List&lt;T&gt; list, Action&lt;T&gt; action)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> iter <span class="keyword">in</span> list)</span><br><span class="line">    &#123;</span><br><span class="line">        action(iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自己以 <code>MyForEach()</code> 實作出 <code>foreach</code> 的 Higher Order Function 版本。</p>
<p>第 9 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">names.MyForEach(name =&gt; Console.WriteLine(name));</span><br></pre></td></tr></table></figure>
<p>原來的 <code>foreach</code> statement 重構成 <code>MyForEach()</code> Higher Order Function 版本，只要將 <code>Console.WriteLine()</code> 改用 Lambda 傳入 <code>MyForEach()</code> 即可，如此 <code>foreach</code> 就能被 reuse 了。</p>
<p>不過 C# 在此可能感受不到 FP 所謂的 Dataflow 與 Pipeline，就語意而言，只能說我們為 List 寫了一個新 method : <code>MyForEach()</code> ，也就是 C# 所謂的 Extension Method，這符合傳統 C# 的 OOP 思維。</p>
<p>他山之石可以攻錯，我們來看看 F# 語法。</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> names = [<span class="string">"Ben"</span>; <span class="string">"Jafar"</span>; <span class="string">"Matt"</span>; <span class="string">"Priya"</span>; <span class="string">"Brian"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> MyForEach action list = </span><br><span class="line">    <span class="keyword">for</span> iter <span class="keyword">in</span> list <span class="keyword">do</span></span><br><span class="line">        action iter</span><br><span class="line">names </span><br><span class="line">|&gt; MyForEach (printfn <span class="string">"%A "</span>)</span><br></pre></td></tr></table></figure>
<p><code>names</code> 為 List，<code>myForEach()</code> 為自己實作的 <code>ForEach()</code> Higher Order function，若不懂 F# 語法先略過細節沒關係。</p>
<p><code>|&gt;</code> 為 pipeline，所以可以明顯看出其語意為 <code>names</code> data 以 Dataflow 與 Pipeline 方式傳給 <code>myForEach()</code> 執行 <code>printfn()</code>。</p>
<p>但 C# 並沒有特別提供 <code>|&gt;</code> 這種 pipeline 符號，而是繼續使用 OOP 的 <code>.</code> 。</p>
<p><code>.</code> 雖然方便，但心裡要知道，這裡的 <code>.</code> 並不是 OOP 的 method，而是 FP 的 Dataflow 與 Pipeline，只是也使用了 <code>.</code> 為符號，其本質是 F# 的 <code>|&gt;</code>，<code>.</code> 算是 <code>|&gt;</code> 的 syntax sugar。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> MyForEach&lt;T&gt;(<span class="keyword">this</span> List&lt;T&gt; list, Action&lt;T&gt; action)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> iter <span class="keyword">in</span> list)</span><br><span class="line">    &#123;</span><br><span class="line">        action(iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再舉例另外一個例子證明 <code>.</code> 並非 OOP 的 method，而是 FP 的 Pipeline。</p>
<p>我們實現 <code>MyForEach()</code> 時，並不是寫在 <code>List</code> class 內，而是透過 static method + this 參數成為 Extenstion Method，也就是<code>List</code> data 與  <code>MyForEach()</code> logic 是徹底分離，而非如 OOP 將 data 與 logic 寫在 <code>List</code> class 內，也再次證明 Extension Method 是 C# 實踐 Pipeline 的手法，而 <code>.</code> 只是 syntax sugar，其本質是 FP 的 Pipeline。</p>
<h2 id="IEnumrable">IEnumrable</h2><hr>
<p><img src="/images/linq/foreach/foreach002.png" alt="foreach002"></p>
<p>當初我們只是想為了 List 重構，所以 Extension Method 的型別只用了 List，Rider 提出建議：<code>List&lt;T&gt; 其實可以重構成 IEnumerable&lt;T&gt;</code>，如此 <code>MyForEach()</code> 重複使用能力更高。</p>
<p><img src="/images/linq/foreach/foreach003.png" alt="foreach003"></p>
<ol>
<li>將 cursor 放在 <code>List</code> 上，按熱鍵 <code>⌥ + ↩</code>，選擇 <code>Make parameter type IEnumerable&lt;T&gt;</code></li>
</ol>
<p><img src="/images/linq/foreach/foreach005.png" alt="foreach005"></p>
<ol>
<li>將 <code>List&lt;T&gt;</code> 重構成 <code>IEnumerable&lt;T&gt;</code>。</li>
</ol>
<h2 id="Method_Group">Method Group</h2><hr>
<p><img src="/images/linq/foreach/foreach008.png" alt="foreach008"></p>
<p>Rider 建議將 Lambda 重構成 Method Group。</p>
<p><code>MyForEach()</code> 後接 Lambda 天經地義，但若 function 的型別定義的很清楚，讓 compiler 可以找到正確 signature 的 Overloading method，則不用寫 Lambda，傳入 method 名稱即可，這就是 Method Group，會讓 FP 寫法更加精簡。</p>
<p><code>MyForEach()</code> 很明確定義了 <code>Action&lt;T&gt;</code>，就只有一個 input 參數的 function，因此 compiler 有足夠的資訊找到 <code>Console.WriteLine()</code> 正確的 Overloading 版本，因此適合重構成 Method Group。</p>
<p><img src="/images/linq/foreach/foreach004.png" alt="foreach003"></p>
<ol>
<li>將 cursor 放在 <code>WriteLine</code> 上，按熱鍵 <code>⌥ + ↩</code>，選擇 <code>Replace with method group</code></li>
</ol>
<p><img src="/images/linq/foreach/foreach006.png" alt="foreach006"></p>
<ol>
<li>只要傳入 Method 名稱即可，不用寫 Lambda</li>
</ol>
<h2 id="Using_static">Using static</h2><hr>
<p>其實目前的 <code>Console.WriteLine</code> 已經非常精簡，可讀性也高，但 C# 6 提供了 <code>using static</code>，可以讓你寫出更 FP 風格的 code。</p>
<p><img src="/images/linq/foreach/foreach007.png" alt="foreach007"></p>
<ol>
<li>將 cursor 放在 <code>Console</code> 上，按熱鍵 <code>⌥ + ↩</code>，選擇 <code>Import static members</code></li>
</ol>
<p><img src="/images/linq/foreach/foreach009.png" alt="foreach009"></p>
<ol>
<li>將 <code>System.Console</code> 使用 <code>using static</code></li>
<li><code>MyForEach()</code> 只要傳入 <code>WriteLine</code> 即可，更像是 function</li>
</ol>
<h2 id="LINQ_:_ForEach">LINQ : ForEach</h2><hr>
<p>其實 <code>ForEach()</code> 這種很普遍的東西，在 LINQ 早已內建，我們改用 LINQ 版本。</p>
<p><img src="/images/linq/foreach/foreach010.png" alt="foreach010"></p>
<ol>
<li>直接使用 LINQ 的 <code>ForEach()</code>，將自己寫的 <code>MyForEach()</code> 刪除</li>
</ol>
<h2 id="LINQ_如何實踐_?">LINQ 如何實踐 ?</h2><hr>
<p><img src="/images/linq/foreach/foreach011.png" alt="foreach011"></p>
<p>我們來看看 LINQ 的 source code 如何實踐 <code>ForEach()</code> ?</p>
<p>一開始對 <code>action</code> 進行判斷，若沒有則拋出 exception。</p>
<p><code>action</code> 也搭配 <code>for</code> 進行，跟我們使用 <code>foreach</code> 類似。</p>
<blockquote>
<p>Q : 為什麼 <code>ForEach()</code> 是在 <code>List</code> class ? 而不是以 Extension Method 實現 ?</p>
</blockquote>
<p>這的確是 LINQ 設計上的好問題，LINQ 並沒有選擇將 <code>ForEach()</code> 以 Extension Method 對 <code>IEnumerable</code> 實作，而是直接寫在 <code>List</code> class 內。</p>
<p>這個設計也使得我們要使用 <code>ForEach()</code> 時，一定得 <code>ToList()</code> 成 List 才能使用。</p>
<p>為了使用上方便，我還是會在自己的 library 為 <code>IEnumerable</code> 加上 <code>ForEach()</code> Extension Method，這樣就不需 <code>ToList()</code> 了。</p>
<h2 id="使用時機">使用時機</h2><hr>
<p><code>ForEach()</code> 表面上看起來是 <code>foreach</code> statement 的 syntax sugar，但事實上 <code>ForEach()</code> 在 FP 的意義並非如此。</p>
<p>FP 將 data 以 Dataflow 與 Pipeline 方式處理，因此提供了眾多 operator，而 operator 則必須搭配 pure function，不能有 Side Effect。但 Side effect 總要有人處理，<code>ForEach()</code> 就是讓你統一處理 Side Effect 之處。</p>
<p>與 Imperative 寫法的差異是 : Imperative 總是不斷的在處理 Side Effect，因此造成結果難以預測、難以測試，bug 就是由此展開；但  FP 對於 data 處理堅持採用 Dataflow 與 Pipeline，不使用 Side Effect，因此對 data 處理是可預測且容易測試，直到最後 data 處理完，才不得已使用 <code>ForEach()</code> 處理 Side Effect。</p>
<p>如 <code>Console.WriteLine()</code> 就是 I/O，就是 Side Effect，這是無法避免的，最後使用 <code>ForEach()</code> 統一解決。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li><code>.</code> 與 Extension Method 是 C# 的 syntax sugar，其本質就是 FP 的 data 與 logic 分離與 Pipeline</li>
<li>Method Group 讓 FP 寫法會更為精簡，也是 C# 很重要的發明</li>
<li>FP 的 operator 主要在處理 Dataflow 與 Pipeline，應該使用 pure function，但 <code>ForEach()</code> 是少數讓你處理 Side Effect 的 operator，應該將 side effect 集中在 <code>ForEach()</code> 處理</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/AppSettingsJson" target="_blank" rel="external">GitHub</a> 上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="http://reactivex.io" target="_blank" rel="external">ReactiveX</a>, <a href="http://reactivex.io/learnrx/" target="_blank" rel="external">Functional Programming in JavaScript</a></p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/fp/intro/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/sonarqube/code-coverage/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-08-04 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/C/">C#<span>13</span></a></li> <li><a href="/tags/LINQ/">LINQ<span>2</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
