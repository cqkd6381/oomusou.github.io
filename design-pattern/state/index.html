<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何使用 TypeScript 實現 State Pattern ? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="使用 OOP 實現 Finite State Machine">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="使用 OOP 實現 Finite State Machine">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 TypeScript 實現 State Pattern ?">
<meta property="og:url" content="http://oomusou.io/design-pattern/state/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="使用 OOP 實現 Finite State Machine">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2018-03-19T01:47:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用 TypeScript 實現 State Pattern ?">
<meta name="twitter:description" content="使用 OOP 實現 Finite State Machine">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何使用 TypeScript 實現 State Pattern ?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 使用 OOP 實現 Finite State Machine			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#User_Story"><span class="toc-article-text">User Story</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Task"><span class="toc-article-text">Task</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Definition"><span class="toc-article-text">Definition</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Architecture"><span class="toc-article-text">Architecture</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Implmentation"><span class="toc-article-text">Implmentation</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#If_Else"><span class="toc-article-text">If Else</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Unit_Test"><span class="toc-article-text">Unit Test</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Refactoring"><span class="toc-article-text">Refactoring</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Guard_Clause"><span class="toc-article-text">Guard Clause</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Enum"><span class="toc-article-text">Enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#State_Pattern"><span class="toc-article-text">State Pattern</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Refactoring-1"><span class="toc-article-text">Refactoring</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Summary"><span class="toc-article-text">Summary</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Similarity"><span class="toc-article-text">Similarity</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Difference"><span class="toc-article-text">Difference</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>State Pattern 是 OOP 中著名的 Design Pattern，當 method 的行為會隨著 field 而改變時特別有效。在本文中，我們將以 Angular 與 TypeScript 實現。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS High Sierra 10.13.3<br>Node.js 8.9.4<br>Angular CLI 1.7.2<br>TypeScript 2.5.3<br>Angular 5.2.7</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/design-pattern/state/state000.png" alt="state000"></p>
<ul>
<li>模擬 iPhone 的 <code>Home</code> 鍵動作</li>
<li><code>Home</code> 雖然只有一個按鍵，但在不同的情境下有不同的功能<ul>
<li>當在 <code>Locked</code> 下，可以 <code>Unlocked</code></li>
<li>當在 <code>Unlocked</code> 下，可以進入 <code>Home</code></li>
<li>當在 <code>App</code> 開啟下，可以回到 <code>Home</code></li>
<li>當在 <code>Desktop</code> 下，可以切換 <code>Home</code></li>
</ul>
</li>
</ul>
<h2 id="Task">Task</h2><hr>
<ul>
<li>因為 <code>Home</code> 有在不同情境下有不同的功能，勢必有很多 <code>if else</code> 判斷情境而切換功能</li>
<li>先用 <code>if else</code> 寫法完成，最後再重構成 State Pattern</li>
</ul>
<h2 id="Definition">Definition</h2><hr>
<blockquote>
<p>State Pattern</p>
<p>當 method 的行為會隨著 field 而改變時，將 <code>if</code> 改用 <code>state</code> 物件表示</p>
<p>將 <code>外部 nested if</code> 改由 <code>內部決定</code> 的 <code>物件串列</code> 表示，藉以消除 <code>if</code> </p>
</blockquote>
<p><img src="/images/design-pattern/state/state015.svg" alt="state015"></p>
<p>將 <code>if</code> 要處理的邏輯包在每個 state 內，但不包含 <code>if</code>。</p>
<p><img src="/images/design-pattern/state/state012.svg" alt="state012"></p>
<ul>
<li><strong>Client</strong> : <code>Context</code> 的 user，實務上可能是 component 或 controller</li>
<li><strong>Context</strong> : 根據 field 的不同，<code>request()</code> 會有不同功能，實務上可能是 service</li>
<li><strong>State</strong> : 定義 <code>ConcreteState</code> 的 interface，只有 <code>handle()</code> ，負責封裝 <code>if 要處理的邏輯</code></li>
<li><strong>ConcreteState</strong> : 將 <code>if 要處理的邏輯</code> 封裝成物件</li>
</ul>
<p>一個 <code>if</code> 要處理的邏輯放在一個 <code>ConcreteState</code> 物件內，並根據 state diagram 指定下一個 state。</p>
<p>由於 method 的行為會根據 field (state) 改變，因此稱為 <code>State</code>  Pattern。</p>
<p><strong>適用時機</strong></p>
<ul>
<li>深層 <code>nested if</code></li>
<li>在 design-time 就可決定 <code>if</code> 組合 (以 state diagram 描述)</li>
<li>當 method 的行為會隨著 field 而改變時</li>
</ul>
<p><strong>優點</strong></p>
<ul>
<li>每個 <code>if 要處理的邏輯</code> 使用一個 class，符合 <code>單一職責原則</code></li>
<li>將來若有新的 <code>if 要處理的邏輯</code>，不用修改 service，而是新增 <code>ConcreState</code>，符合 <code>開放封閉原則</code></li>
<li>Client 與 <code>if 判斷</code> 解耦合，兩者都僅相依於 interface，符合 <code>依賴反轉原則</code></li>
<li>可使用 state diagram 清楚描述狀態轉變</li>
</ul>
<p><strong>缺點</strong> </p>
<ul>
<li>若邏輯複雜，state class 可能會很多檔案，但還是比單一檔案 <code>nested if</code> 好維護</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/design-pattern/state/state013.svg" alt="state013"></p>
<ul>
<li>只有在 <code>Unlock</code>、<code>App</code> 與 <code>Desktop</code> 才能使用 <code>Home</code> 鍵</li>
<li>只有在 <code>Home</code> 與 <code>Desktop</code> 才能切到 <code>App</code></li>
<li>只有 <code>Home</code> 才能切到 <code>Desktop</code></li>
</ul>
<p><img src="/images/design-pattern/state/state002.svg" alt="state002"></p>
<ul>
<li><code>AppComponent</code> 相當於 <code>Client</code></li>
<li><code>PhoneContext</code> 相當於 <code>Context</code>，<code>AppComponent</code> 負責注入 <code>PhoneContext</code>，無論怎麼重構，<code>PhoneContext</code> 都是穩定的，不會導致 <code>AppComponent</code> 修改</li>
<li><code>PhoneStateInterface</code> 相當於 <code>State</code> interface，訂出所有 state 標準</li>
<li><code>LockedState</code> 及其他 state 都是 <code>ConcreteState</code>，為實際 <code>if</code> 所處理的邏輯</li>
</ul>
<h2 id="Implmentation">Implmentation</h2><hr>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onHomeClick()"</span>&gt;</span>Home<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onOpenAppClick()"</span>&gt;</span>Open App<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onSwitchDesktopClick()"</span>&gt;</span>Switch Desktop<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">&#123;&#123; message &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>在 HTML 提供 <code>Home</code>、<code>Open App</code> 與 <code>Switch Desktop</code> 3 個 button，任何訊息將顯示在 <code>message</code>。</p>
<h3 id="If_Else">If Else</h3><p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  <span class="keyword">private</span> state = <span class="string">'Locked'</span>;</span><br><span class="line">  message = <span class="string">'The phone is locked'</span>;</span><br><span class="line"></span><br><span class="line">  onHomeClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Locked'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Unlocked'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is unlocked'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Unlocked'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'App'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onOpenAppClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span> || <span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'App'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is opening app'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSwitchDesktopClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Desktop'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is switching desktop'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">onHomeClick() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Locked'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Unlocked'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is unlocked'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Unlocked'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'App'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>Home</code> 鍵，由於 <code>Home</code> 在不同情境有不同功能，因此分成 <code>Locked</code>、<code>Unlocked</code>、<code>Home</code>、<code>App</code> 與 <code>Desktop</code> 5 個 state，使用 <code>if</code> 判斷當目前什麼 state 下，要做什麼事情，以及即將切到什麼 state。</p>
<p>31 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">onOpenAppClick() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span> || <span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'App'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is opening app'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>開啟 App</code>，根據 state diagram，由於不可能在 <code>Locked</code>、<code>Unlocked</code> 與 <code>App</code> state 下開啟 app，將顯示 <code>The operation is not allowed</code>，並切到特別建立的 <code>Null</code> state。</p>
<p>也就是只有 <code>Home</code> 與 <code>Desktop</code> state 下才能開啟 app，因此特別使用 <code>if else</code> 做判斷。</p>
<p>41 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">onSwitchDesktopClick() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Desktop'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is switching desktop'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>切換桌面</code>，根據 state diagram，只能在 <code>Home</code> state 下切換桌面，因此需要 <code>if else</code> 做判斷。</p>
<blockquote>
<p>以功能面來說，目前已經完全需求，只是程式碼含有眾多的 code smell，尚無法達成 production code 的標準，需要繼續重構。</p>
</blockquote>
<h3 id="Unit_Test">Unit Test</h3><p>在重構之前，必須要有測試保護，才能確保沒把原本的商業邏輯重構壞，因此我們先準備好 <code>AppComponent</code> 的 Unit Test，確保每個 <code>if else</code> 的 path 都有測到。</p>
<p><strong>app.component.spec.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ComponentFixture, TestBed &#125; from <span class="string">'@angular/core/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DebugElement &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'AppComponent'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> fixture: ComponentFixture&lt;AppComponent&gt;;</span><br><span class="line">  <span class="keyword">let</span> appComponent: AppComponent;</span><br><span class="line">  <span class="keyword">let</span> debugElement: DebugElement;</span><br><span class="line">  <span class="keyword">let</span> htmlElement: HTMLElement;</span><br><span class="line">  <span class="keyword">let</span> target: AppComponent;</span><br><span class="line"></span><br><span class="line">  beforeEach(() =&gt; &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      declarations: [</span><br><span class="line">        AppComponent</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    fixture = TestBed.createComponent(AppComponent);</span><br><span class="line">    appComponent = fixture.componentInstance;</span><br><span class="line">    debugElement = fixture.debugElement;</span><br><span class="line">    htmlElement = debugElement.nativeElement;</span><br><span class="line">    target = <span class="keyword">new</span> AppComponent();</span><br><span class="line">    fixture.detectChanges();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should create the app'</span>, () =&gt; &#123;</span><br><span class="line">    expect(appComponent).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`一開始應顯示 <span class="string">'The phone is locked'</span>`, () =&gt; &#123;</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is locked'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">1</span> 次按下 Home 應顯示 <span class="string">'The phone is unlocked'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is unlocked'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">2</span> 次按下 Home 應顯示 <span class="string">'The phone is at home'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is at home'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">3</span> 次按下 Home 應顯示 <span class="string">'The phone is at home'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is at home'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">2</span> 次按下 Home 與第一次按下 Open App 應顯示 <span class="string">'The phone is at home'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onOpenAppClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is opening app'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當按下 Open App 再按下 Home 應顯示 <span class="string">'The phone is at home'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onOpenAppClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is at home'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">2</span> 次按下 Home 與第一次按下 Switch Desktop 應顯示 <span class="string">'The phone is switching desktop'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onSwitchDesktopClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is switching desktop'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當按下 Switch Desktop 再按下 Home 應顯示 <span class="string">'The phone is switching desktop'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onSwitchDesktopClick();</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The phone is at home'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">1</span> 次按下 Home 再按下 Open App 應顯示 <span class="string">'The operation is not allowed'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onOpenAppClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The operation is not allowed'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`當第 <span class="number">1</span> 次按下 Home 再按下 Switch Desktop 應顯示 <span class="string">'The operation is not allowed'</span>`, () =&gt; &#123;</span><br><span class="line">    appComponent.onHomeClick();</span><br><span class="line">    appComponent.onSwitchDesktopClick();</span><br><span class="line">    expect(appComponent.message).toBe(<span class="string">'The operation is not allowed'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>由於本文重點不是在講 Unit Test，因此就不浪費篇幅解釋以上程式碼。</p>
<p><img src="/images/design-pattern/state/state001.png" alt="state001"></p>
<p>執行 Wallaby.js 單元測試，確保 <code>AppComponent</code> 所有的 <code>if else</code> 的 path 都有測到，也就是 coverage 是 <code>100%</code>，接下來的重構將以此 Unit Test 為標準，無論怎麼重構，都必須確保 11 個測試案例 <code>綠燈</code>。</p>
<blockquote>
<p>實務上若 TDD 有困難，其實可以先用 <code>if else</code> 寫一段 <code>比較髒</code> 的 production code，最少功能都符合需求，因為 <code>比較髒</code>，所以一定得重構，在重構之前補上 Unit Test，重點是 coverage 是 <code>100%</code>，然後不斷的重構維持 Unit Test 都是 <code>綠燈</code>，無論是先寫測試或是後寫測試，但要寫 Unit Test 與重構的目標都是一致的，只是先寫還是後寫而已。</p>
<p>若發現 <code>比較髒</code> 的 production code 已經無法寫出 Unit Test，就必須回頭修改 production code 寫法，那表示你的 production code 已經違反 SOLID 原則，導致 Unit Test 寫不出來。</p>
</blockquote>
<h3 id="Refactoring">Refactoring</h3><p>目前這段 code 至少含有以下 3 項 code smell : </p>
<ol>
<li>使用 <code>else</code> 造成 <code>nested if</code></li>
<li><code>state</code> 與 <code>message</code> 目前都以 <code>string</code> hardcode</li>
<li><code>onHomeClick()</code> 眾多 <code>if else</code> 嚴重違反 <code>單一職責原則</code> 與 <code>開放封閉原則</code></li>
</ol>
<p>我們將針對這 3 點加以重構。</p>
<h3 id="Guard_Clause">Guard Clause</h3><p>重構目標 : 使用 Guard Clause 取代 <code>else</code>。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  <span class="keyword">private</span> state = <span class="string">'Locked'</span>;</span><br><span class="line">  message = <span class="string">'The phone is locked'</span>;</span><br><span class="line"></span><br><span class="line">  onHomeClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Locked'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Unlocked'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is unlocked'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Unlocked'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'App'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onOpenAppClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span> || <span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'App'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is opening app'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSwitchDesktopClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Home'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="string">'Desktop'</span>;</span><br><span class="line">      <span class="keyword">this</span>.message = <span class="string">'The phone is switching desktop'</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'Null'</span>;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="string">'The operation is not allowed'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>25 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'App'</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">  <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.state === <span class="string">'Desktop'</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line">  <span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.state = <span class="string">'Home'</span>;</span><br><span class="line"><span class="keyword">this</span>.message = <span class="string">'The phone is at home'</span>;</span><br></pre></td></tr></table></figure>
<p>以 <code>return</code> 取代 <code>else</code>，換來 <code>if</code> 全部壓平在第一層，避免寫出 <code>nested if</code>。</p>
<p>最後一行即為預設值。</p>
<p>其他皆以這種方式重構。</p>
<h3 id="Enum">Enum</h3><p>重構目標 : 使用 <code>enum</code> 取代 <code>string</code> hardcode。</p>
<p><strong>message.enum.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> MessageEnum &#123;</span><br><span class="line">  Locked   = <span class="string">'The phone is locked'</span>,</span><br><span class="line">  Unlocked = <span class="string">'The phone is unlocked'</span>,</span><br><span class="line">  Home     = <span class="string">'The phone is at home'</span>,</span><br><span class="line">  App      = <span class="string">'The phone is opening app'</span>,</span><br><span class="line">  Desktop  = <span class="string">'The phone is switching desktop'</span>,</span><br><span class="line">  Null     = <span class="string">'The operation is not allowed'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前 <code>state</code> 與 <code>message</code> 都使用 <code>string</code> hardcode，使用上雖然直覺簡單，但有兩個致命缺點 :</p>
<ol>
<li><code>message</code> 到處散佈，將來若 <code>message</code> 修改，要改的地方很多</li>
<li><code>state</code> 使用 <code>string</code>，不僅容易 typo，也無法受到 compiler 保護</li>
</ol>
<p>比較好的方式是 <code>state</code> 由 <code>string</code> 改由 <code>enum</code>，如此不會 typo，也受到 compiler 保護。</p>
<blockquote>
<p>一般語言由於 <code>enum</code> 傳統只能代表 <code>int</code>，因此還掉搭配其他 collection，如 ES6  的 <code>Map</code> 或 C# 的 <code>Dictionary</code> ，但 TypeScript 2.4 的 <code>enum</code> 可代表 <code>string</code>，因此可省掉 <code>Map</code> 或 <code>Dictionary</code>，直接使用 <code>enum</code> 搞定。</p>
</blockquote>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  message = MessageEnum.Locked;</span><br><span class="line"></span><br><span class="line">  onHomeClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Locked) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.Unlocked;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Unlocked) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.Home;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.App) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.Home;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Desktop) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.Home;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.message = MessageEnum.Home;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onOpenAppClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Home || <span class="keyword">this</span>.message === MessageEnum.Desktop) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.App;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.message = MessageEnum.Null;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSwitchDesktopClick() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Home) &#123;</span><br><span class="line">      <span class="keyword">this</span>.message = MessageEnum.Desktop;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.message = MessageEnum.Null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = MessageEnum.Locked;</span><br></pre></td></tr></table></figure>
<p>將 <code>state</code> 拿掉，只留下 <code>message</code>。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.message === MessageEnum.Locked) &#123;</span><br><span class="line">  <span class="keyword">this</span>.message = MessageEnum.Unlocked;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本判斷 <code>state</code>，直接判斷 <code>message</code> 即可。</p>
<p>其他以此類推。</p>
<h3 id="State_Pattern">State Pattern</h3><p>重構目標 : 使用 State Pattern 實現 <code>單一職責原則</code> 與 <code>開放封閉原則</code>。</p>
<p><strong>AppComponent</strong></p>
<p><img src="/images/design-pattern/state/state010.svg" alt="state010"></p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhoneContext &#125; from <span class="string">'./phone.context'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; from <span class="string">'./AppState'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DesktopState &#125; from <span class="string">'./DesktopState'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  message = MessageEnum.Locked;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private phoneContext: PhoneContext) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onHomeClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="keyword">this</span>.phoneContext.request();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onOpenAppClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="keyword">this</span>.phoneContext.setState(<span class="keyword">new</span> AppState());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSwitchDesktopClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.message = <span class="keyword">this</span>.phoneContext.setState(<span class="keyword">new</span> DesktopState());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private phoneContext: PhoneContext) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 DI 依賴注入 <code>PhoneContext</code>。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onHomeClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.message = <span class="keyword">this</span>.phoneContext.request();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>onHomeClick()</code> 只剩下一行 <code>Context.request()</code>。</p>
<blockquote>
<p>我們可以發現 <code>onHomeClick()</code> 的 <code>if</code> 都不見了，也就是說，State Pattern 用多個檔案的 class 去換一個檔案的 <code>if</code> 。</p>
<ul>
<li>由於多個檔案，一個 class 代表一個 <code>if</code> ，符合 <code>單一職責原則</code></li>
<li>將來若有新的 state，只要根據 interface 新增 class，不用修改原來的 code，符合 <code>開放封閉原則</code></li>
</ul>
</blockquote>
<p>22 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onOpenAppClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.message = <span class="keyword">this</span>.phoneContext.setState(<span class="keyword">new</span> AppState());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本需要在 client 判斷是否可以切換 state，現在只管新增 state 即可，不用再用 <code>if</code> 判斷。</p>
<p><strong>PhoneContext</strong></p>
<p><img src="/images/design-pattern/state/state003.svg" alt="state003"></p>
<p><strong>phone.context.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Inject, Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterfaceToken &#125; from <span class="string">'./interface.token'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PhoneContext &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(@Inject(PhoneStateInterfaceToken) private state: PhoneStateInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  request(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.state.handle();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.getMessage();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state: PhoneStateInterface): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">if</span> (!state.chkContext(<span class="keyword">this</span>.state)) &#123;</span><br><span class="line">      <span class="keyword">return</span> MessageEnum.Null;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state;</span><br><span class="line">      <span class="keyword">return</span> state.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(@Inject(PhoneStateInterfaceToken) private state: PhoneStateInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即將使用 State Pattern，使用 DI 依賴注入 <code>state</code>，注意其型別為 <code>PhoneStateInterface</code>。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request(): MessageEnum &#123;</span><br><span class="line">  <span class="keyword">this</span>.state = <span class="keyword">this</span>.state.handle();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.state.getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>request()</code> 為原本 State Pattern 所設計的 method。</p>
<p>執行目前 <code>state</code> 的 <code>handle()</code>，此為目前 state 主要的商業邏輯所在。</p>
<p><code>handle()</code> 將回傳下一個 <code>state</code>。</p>
<p><code>state.getMessage()</code> 將回傳目前 <code>state</code> 要顯示的訊息。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setState(state: PhoneStateInterface): MessageEnum &#123;</span><br><span class="line">  <span class="keyword">if</span> (!state.chkContext(<span class="keyword">this</span>.state)) &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Null;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = state;</span><br><span class="line">    <span class="keyword">return</span> state.getMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setState()</code> 並非 State Pattern 所設計的 method，目前因為 <code>Open App</code> 與 <code>Switch Desktop</code> 需要動態切換 state，因而衍生出動態設定 state 的需求。</p>
<p>由於不是每個 state 都能任意切換到其他 state，因此特別在每個 state 設計 <code>chkContext()</code>，判斷是否允許切換 state。</p>
<blockquote>
<p><code>Context.setState()</code> 與 <code>State.chkContext()</code> 並非原始 State Pattern 所設計，為了能動態切換 state，實務上經常會有此需求</p>
</blockquote>
<p><strong>PhoneStateInterface</strong></p>
<p><img src="/images/design-pattern/state/state004.svg" alt="state004"></p>
<p><strong>phone.state.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> PhoneStateInterface </span>&#123;</span><br><span class="line">  handle(): PhoneStateInterface;  </span><br><span class="line">  getMessage(): MessageEnum;</span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 State Pattern 的 interface ：</p>
<ul>
<li><code>handle()</code> : 為 State Pattern 所設計的 method，專門放每個 <code>if</code> 的邏輯</li>
<li><code>getMessage()</code> : 回傳目前 state 的 message，非 State Pattern 所設計，為根據目前需求所設計的 method</li>
<li><code>chkContext()</code> : 檢查目前 state 是否可以允許切換到下一個 state，非 State Pattern 所設計，為根據目前需求所設計的 method</li>
</ul>
<p><strong>LockedState</strong></p>
<p><img src="/images/design-pattern/state/state005.svg" alt="state005"></p>
<p>接下來要將每個 state 的 <code>if</code> 搬進 class，實現 <code>單一職責原則</code> 與 <code>開放封閉原則</code>。</p>
<p><strong>locked.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UnlockedState &#125; from <span class="string">'./UnlockedState'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> LockedState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnlockedState();</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Locked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handle(): PhoneStateInterface &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> UnlockedState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將原本 <code>Locked</code> state 的 code 搬到 <code>handle()</code>，最後回傳下一個 state，其型別為 <code>PhoneStateInterface</code>。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getMessage(): MessageEnum &#123;</span><br><span class="line">  <span class="keyword">return</span> MessageEnum.Locked;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回傳目前 state 的 message，注意其型別為 <code>MessageEnum</code>，而不是 <code>string</code>。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>檢查目前 state 是否進進入 <code>Locked</code> state，因為毫無限制，傳回 <code>true</code> 即可。</p>
<p><strong>UnlockedState</strong></p>
<p><img src="/images/design-pattern/state/state006.svg" alt="state006"></p>
<p><strong>unlocked.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HomeState &#125; from <span class="string">'./HomeState'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UnlockedState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Unlocked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state.getMessage() === MessageEnum.Locked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> state.getMessage() === MessageEnum.Locked;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 state diagram，只有當 <code>Locked</code> state 才能進入 <code>Unlocked</code> state。</p>
<p><strong>HomeState</strong></p>
<p><img src="/images/design-pattern/state/state007.svg" alt="state007"></p>
<p><strong>home.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> HomeState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Home;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>與 <code>LockedState</code> 類似，就不再贅述。</p>
<p><strong>AppState</strong></p>
<p><img src="/images/design-pattern/state/state008.svg" alt="state008"></p>
<p><strong>app.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HomeState &#125; from <span class="string">'./HomeState'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.App;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state.getMessage() === MessageEnum.Home) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state.getMessage() === MessageEnum.Desktop) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (state.getMessage() === MessageEnum.Home) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (state.getMessage() === MessageEnum.Desktop) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 state diagram，只有 <code>Home</code> 與 <code>Desktop</code> state 才能進入 <code>App</code> state。</p>
<p><strong>DesktopState</strong></p>
<p><img src="/images/design-pattern/state/state009.svg" alt="state009"></p>
<p><strong>desktop.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HomeState &#125; from <span class="string">'./home.state'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DesktopState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Desktop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state.getMessage() === MessageEnum.Home) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 state diagram，只有 <code>Home</code> state 才能進入 <code>Desktop</code> state。</p>
<h3 id="Refactoring-1">Refactoring</h3><p><strong>PhoneContext</strong></p>
<p><img src="/images/design-pattern/state/state003.svg" alt="state003"></p>
<p><strong>phone.context.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Inject, Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterfaceToken &#125; from <span class="string">'./interface.token'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PhoneContext &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(@Inject(PhoneStateInterfaceToken) private state: PhoneStateInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  request(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.state.handle();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.getMessage();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state: PhoneStateInterface): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">const</span> setCurrentState = (currentState) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = currentState;</span><br><span class="line">      <span class="keyword">return</span> currentState.getMessage();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !state.chkContext(<span class="keyword">this</span>.state) ? MessageEnum.Null :</span><br><span class="line">           setCurrentState(state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setState(state: PhoneStateInterface): MessageEnum &#123;</span><br><span class="line">  <span class="keyword">const</span> setCurrentState = (currentState) =&gt; &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = currentState;</span><br><span class="line">    <span class="keyword">return</span> currentState.getMessage();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> !state.chkContext(<span class="keyword">this</span>.state) ? MessageEnum.Null :</span><br><span class="line">          setCurrentState(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將原本的 <code>if else</code> 重構成 <code>?:</code> 。</p>
<p>尤其原本 <code>else</code> 的部分抽成 function，讓可讀性更高。</p>
<p><strong>AppState</strong></p>
<p><img src="/images/design-pattern/state/state008.svg" alt="state008"></p>
<p><strong>app.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HomeState &#125; from <span class="string">'./home.state'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.App;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state.getMessage() === MessageEnum.Home ? <span class="literal">true</span> :</span><br><span class="line">           state.getMessage() === MessageEnum.Desktop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> state.getMessage() === MessageEnum.Home ? <span class="literal">true</span> :</span><br><span class="line">         state.getMessage() === MessageEnum.Desktop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>if else</code> 重構成 <code>?:</code>。</p>
<p><strong>DesktopState</strong></p>
<p><img src="/images/design-pattern/state/state009.svg" alt="state009"></p>
<p><strong>destop.state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PhoneStateInterface &#125; from <span class="string">'./phone.state.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageEnum &#125; from <span class="string">'./message.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HomeState &#125; from <span class="string">'./home.state'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DesktopState <span class="keyword">implements</span> PhoneStateInterface &#123;</span><br><span class="line">  getMessage(): MessageEnum &#123;</span><br><span class="line">    <span class="keyword">return</span> MessageEnum.Desktop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state.getMessage() === MessageEnum.Home;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(): PhoneStateInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HomeState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chkContext(state: PhoneStateInterface): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> state.getMessage() === MessageEnum.Home;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>if else</code> 重構成 <code>?:</code>。</p>
<p><img src="/images/design-pattern/state/state014.png" alt="state014"></p>
<p>經過一系列的重構成 State Pattern，一樣必須確認 Wallaby.js 單元測試的 11 個測試案例都是 <code>綠燈</code>。</p>
<h2 id="Summary">Summary</h2><hr>
<blockquote>
<p>Chain of Responsibility Pattern vs. State Pattern</p>
</blockquote>
<p><img src="/images/design-pattern/state/state016.svg" alt="state016"></p>
<p>以 class diagram 角度，Chain of Responsibility 與 State Pattern 完全一樣。</p>
<blockquote>
<p>學 Design Pattern 不能以 class diagram 的角度去思考，而要以他要解決什麼問題來思考</p>
</blockquote>
<h3 id="Similarity">Similarity</h3><ul>
<li>解決 <code>nested if</code> 難以維護</li>
<li>都是將 <code>if</code> 改用 object 表示</li>
</ul>
<h3 id="Difference">Difference</h3><ul>
<li>CoR 特別適用於一連串的 <code>判斷檢查</code>；State 特別適用於 method 功能隨 field 改變</li>
<li>CoR 內仍然會有 <code>if</code>；State 內無 <code>if</code></li>
<li>CoR 由 <code>外部</code> 決定下一個 handler；State 由 <code>內部</code> 決定下一個 state</li>
<li>State 會搭配 state diagam 描述 state 的切換</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>並不是所有的 <code>if</code> 都該使用 State Pattern，當 method 功能會隨 field 改變時特別適用，如複雜的 GUI，button 可能根據不同情境有不同功能</li>
<li>Chain of Responsibility 與 State Pattern，從 class diagram 角度，兩者完全一樣，但適用時機與語意是不同的，尤其 Chain of Responsibility 是由外部決定 <code>if</code> 順序，但 State Pattern 是由內部決定 <code>if</code> 順序</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52State" target="_blank" rel="external">GitHub</a> 上找到</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/vscode/netcore/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/docker/mount-host-dir/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-03-09 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Angular/">Angular<span>48</span></a></li> <li><a href="/tags/Design-Pattern/">Design Pattern<span>17</span></a></li> <li><a href="/tags/TypeScript/">TypeScript<span>23</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
