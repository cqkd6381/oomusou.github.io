<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>重構到設計模式：使用 Adapter Pattern | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="以實際範例一步步重構成 Adapter Pattern">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="以實際範例一步步重構成 Adapter Pattern">
<meta property="og:type" content="article">
<meta property="og:title" content="重構到設計模式：使用 Adapter Pattern">
<meta property="og:url" content="http://oomusou.io/design-pattern/adapter/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="以實際範例一步步重構成 Adapter Pattern">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2018-02-18T10:09:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="重構到設計模式：使用 Adapter Pattern">
<meta name="twitter:description" content="以實際範例一步步重構成 Adapter Pattern">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 重構到設計模式：使用 Adapter Pattern</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 以實際範例一步步重構成 Adapter Pattern			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#定義"><span class="toc-article-text">定義</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#生活中的_Adapter"><span class="toc-article-text">生活中的 Adapter</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#VGA_Adapter"><span class="toc-article-text">VGA Adapter</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#真實案例"><span class="toc-article-text">真實案例</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用_AWS_S3"><span class="toc-article-text">使用 AWS S3</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用_Azure_Blob_Storage"><span class="toc-article-text">使用 Azure Blob Storage</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用阿里雲_OSS"><span class="toc-article-text">使用阿里雲 OSS</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#開放封閉原則"><span class="toc-article-text">開放封閉原則</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#實務上的_Adapter"><span class="toc-article-text">實務上的 Adapter</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Adapter_的變形"><span class="toc-article-text">Adapter 的變形</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>Adapter pattern 是實務上常用的設計模式，本文將以實際案例，根據需求一步步重構，最後變成 adapter pattern。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.15</p>
<h2 id="定義">定義</h2><hr>
<blockquote>
<p>Convert the interface of a class into another interface clients expect. Adapter lets classes work together that couldn’t otherwise of incompatible interfaces.</p>
<p>將一個 class 的接口變成使用端所期待的另外一種接口，從而使原本因接口不匹配而無法在一起工作的兩個 class 都能在一起工作。</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>當 service 原本支援某一 API ，卻被要求支援另一新 API，可開發 adapter 讓原 service 支援新 API。</p>
</blockquote>
<p><img src="/images/dp/dp-adapter/adapter000.svg" alt="adapter000"></p>
<p><img src="/images/dp/dp-adapter/adapter010.svg" alt="adapter010"></p>
<ul>
<li><strong>Client</strong> : 使用端根據 <code>Target</code> interface 使用 <code>Adapter</code> 物件。</li>
</ul>
<blockquote>
<p>Controller 根據 service 的 interface 去使用 adapter。</p>
</blockquote>
<ul>
<li><strong>Target</strong> : 根據使用端的 domain 需求定義出的 service 的 <code>Target</code> interface。</li>
</ul>
<blockquote>
<p>Service 根據 controller 的需求，定義出 service 的 interface。</p>
</blockquote>
<ul>
<li><strong>Adapter</strong> : 根據 <code>Target</code> interface 實作出 <code>Adapter</code>，再由 <code>Adapter</code> 去使用 <code>Adaptee</code>。</li>
</ul>
<blockquote>
<p>根據 service 的 interface 實作出 adapter，再由 adapter 去使用實際的第三方套件或 API。</p>
</blockquote>
<ul>
<li><strong>Adaptee</strong> : 被 <code>Adapter</code> 呼叫的 <code>Adaptee</code>。</li>
</ul>
<blockquote>
<p>實際的第三方套件或 API。</p>
</blockquote>
<h2 id="生活中的_Adapter">生活中的 Adapter</h2><hr>
<p>Adapter 在生活中到處可見。</p>
<h3 id="VGA_Adapter">VGA Adapter</h3><p><img src="/images/dp/dp-adapter/adapter001.jpg" alt="adapter001"></p>
<p>我的 Macbook Pro Retina 只有 Mini Display port，但投影機只有 VGA port，因此 Macbook 無法直接使用投影機，需要 VGA adapter 做轉接。</p>
<blockquote>
<p>我的 controller 只支援 Mini Display port interface，但第三方套件或 API 卻只提供 VGA interface，因此 controller 無法直接使用第三方套件或 API，因此需要 adapter 做轉接，才能使用第三方套件或 API。</p>
</blockquote>
<p>若以 Adapter pattern 思考</p>
<blockquote>
<p><code>Client</code> 就類似 Macbook，<code>Adaptee</code> 就類似投影機，這些都是不能修改的，我們只好以 MacBook 角度訂出 <code>Target</code> interface，然後實做 VGA Adapter 實作 <code>Target</code> interface，這樣 MacBook 就能使用投影機了。</p>
</blockquote>
<h2 id="真實案例">真實案例</h2><hr>
<h3 id="使用_AWS_S3">使用 AWS S3</h3><p>AWS 提供 S3 (Simple Storage Service) 服務，讓我們可以上傳檔案到雲端，並且下載。AWS 也提供了 <code>AWS SDK for PHP</code> 供 PHP 使用。</p>
<p>AWS 的 API 如下 (<code>AWSSDK</code>)</p>
<table>
<thead>
<tr>
<th>功能描述</th>
<th>API</th>
</tr>
</thead>
<tbody>
<tr>
<td>上傳檔案</td>
<td>putObject(＄container, ＄blob, ＄file)</td>
</tr>
<tr>
<td>下載連結</td>
<td>getObjectUrl(＄container, ＄blob)</td>
</tr>
<tr>
<td>刪除檔案</td>
<td>deleteObjet(＄container, ＄blob)</td>
</tr>
</tbody>
</table>
<p><img src="/images/dp/dp-adapter/adapter002.svg" alt="adapter002"></p>
<p><strong>下載檔案</strong><br><img src="/images/dp/dp-adapter/adapter011.svg" alt="adapter002"></p>
<p><strong>CloudStorageController</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">CloudStorageService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudStorageController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> CloudStorageService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cloudStorageService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * CloudStorageController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> CloudStorageService $cloudStorageService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(CloudStorageService <span class="variable">$cloudStorageService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudStorageService = <span class="variable">$cloudStorageService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 下載檔案</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$this</span>-&gt;cloudStorageService-&gt;getFileUrl(<span class="string">'MyFolder'</span>, <span class="string">'MyRemoteFile'</span>);</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudStorageService-&gt;uploadFile(<span class="string">'MyFolder'</span>, <span class="string">'MyRemoteFile'</span>, <span class="string">'MyLocalFile'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudStorageService-&gt;deleteFile(<span class="string">'MyFolder'</span>, <span class="string">'MyRemote'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> CloudStorageService */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$cloudStorageService</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * CloudStorageController constructor.</span><br><span class="line"> * <span class="doctag">@param</span> CloudStorageService $cloudStorageService</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(CloudStorageService <span class="variable">$cloudStorageService</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;cloudStorageService = <span class="variable">$cloudStorageService</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CloudStorageController</code> 使用到了 <code>CloudStorageService</code>，在 constructor 使用依賴注入將 <code>CloudStorageService</code> 注入。</p>
<p>19 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 下載檔案</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$this</span>-&gt;cloudStorageService-&gt;getFileUrl(<span class="string">'MyFolder'</span>, <span class="string">'MyRemoteFile'</span>);</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$url</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>index()</code> 呼叫 <code>CloudStorageService</code> 的 <code>getFileUrl()</code> 回傳下載檔案的 url。</p>
<p>28 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 上傳檔案</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;cloudStorageService-&gt;uploadFile(<span class="string">'MyFolder'</span>, <span class="string">'MyRemoteFile'</span>, <span class="string">'MyLocalFile'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>store()</code> 呼叫 <code>CloudStorageService</code>  的 <code>uploadFile()</code> 上傳檔案。</p>
<p>36 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除檔案</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;cloudStorageService-&gt;deleteFile(<span class="string">'MyFolder'</span>, <span class="string">'MyRemote'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>destroy()</code> 呼叫 <code>CloudStorageService</code> 的 <code>deleteFile()</code> 刪除檔案。</p>
<p><strong>CloudStorageService</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">SDK</span>\<span class="title">AWSSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudStorageService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AWSSDK */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$awsSDK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * CloudStorageService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK = <span class="keyword">new</span> AWSSDK();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     * <span class="doctag">@param</span> string $localFile</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>, string <span class="variable">$localFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK-&gt;putObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>, <span class="variable">$localFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 下載檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileUrl</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;awsSDK-&gt;getObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK-&gt;deleteObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>實際的提供雲端檔案服務的 service。</p>
<p>第 10 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> AWSSDK */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$awsSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * CloudStorageService constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;awsSDK = <span class="keyword">new</span> AWSSDK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>CloudStorageService</code> 使用到了  <code>AWSSDK</code>。</p>
<blockquote>
<p>這裡可以使用依賴注入，不過依賴注入就得搭配 provider 機制，這裡故意使用 <code>new</code>，將來要搭配 Factory Pattern。</p>
</blockquote>
<p>18 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 上傳檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $folder</span><br><span class="line"> * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line"> * <span class="doctag">@param</span> string $localFile</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>, string <span class="variable">$localFile</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;awsSDK-&gt;putObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>, <span class="variable">$localFile</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呼叫 <code>AWSSDK</code> 的 <code>putObject()</code> 上傳檔案。</p>
<p>29 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 下載檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $folder</span><br><span class="line"> * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line"> * <span class="doctag">@return</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileUrl</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;awsSDK-&gt;getObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呼叫 <code>AWSSDK</code> 的 <code>getObject()</code> 下載檔案。</p>
<p>40 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $folder</span><br><span class="line"> * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;awsSDK-&gt;deleteObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呼叫 <code>AWSSDK</code> 的 <code>deleteObject()</code> 刪除檔案。</p>
<p><strong>AWSSDK</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">SDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AWSSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">putObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'AWS S3 uploading file'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span>: <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'http://www.aws.com'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'AWS S3 deleting file'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 上傳檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@param</span> string $file</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">putObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">'AWS S3 uploading file'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>AWSSDK</code> 的 <code>putObject()</code>。</p>
<p>16 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 回傳下載檔案 url</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@return</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span>: <span class="title">string</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'http://www.aws.com'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>AWSSDK</code> 的 <code>getObject()</code>。</p>
<p>27 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">'AWS S3 deleting file'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>AWSSDK</code> 的 <code>deleteObject()</code>。</p>
<h3 id="使用_Azure_Blob_Storage">使用 Azure Blob Storage</h3><p>Microsof 的 Azure 雲端服務急起直追，且提供比 AWS 更優惠方案，公司高層為了降低成本，決定將檔案改放到 Azure 。</p>
<p>Azure 提供 Blob Storage 服務，功能與 S3 完全一樣，Microsoft 也提供了 <code>Azure SDK for PHP</code> 供 PHP 使用。</p>
<blockquote>
<p>公司另有但書，先不要將原本 AWS S3 的程式碼刪除，因為有可能 Azure 便宜但不好用，將來有可能會回來用 AWS S3，希望提供<strong>設定檔</strong>，能動態切換使用 AWS S3 或 Azure Blob。</p>
</blockquote>
<p>Azure 的 API 如下 (<code>AzureSDK</code>)</p>
<table>
<thead>
<tr>
<th>功能描述</th>
<th>API</th>
</tr>
</thead>
<tbody>
<tr>
<td>上傳檔案</td>
<td>createBlob(＄container, ＄blob, ＄file)</td>
</tr>
<tr>
<td>下載連結</td>
<td>getBlobUrl(＄container, ＄blob)</td>
</tr>
<tr>
<td>刪除檔案</td>
<td>deleteBlob(＄container, ＄blob)</td>
</tr>
</tbody>
</table>
<p>根據<strong>開放封閉原則</strong>，<code>AzureSDK</code> 屬於新的需求，我們可以新增 class 支援 <code>AzureSDK</code> (<strong><em>對擴展是開放的</em></strong>)，但不應該去修改原有<code>CloudStorageService</code> (<strong><em>對修改是封閉的</em></strong>)。</p>
<blockquote>
<p>我們不應該在 CloudStorageService 使用 <code>if else</code> 去判斷該使用 <code>AWSSDK</code> 或 <code>AzureSDK</code>，因為 <code>CloudStorageService</code> 應該封閉，應該新增 class，改用物件導向<strong>多型</strong>取代 <code>if else</code>。</p>
</blockquote>
<p>由於 <code>CloudStorageService</code> 原本已經使用 <code>AWSSDK</code>，為了讓 <code>CloudStorageService</code> 封閉不做修改，我們決定以既有的 <code>AWSSDK</code> 為基礎加以 <code>extract interface</code> 產生 <code>CloudSDK</code> interface 。</p>
<p><img src="/images/dp/dp-adapter/adapter003.svg" alt="adapter003"></p>
<p><strong>下載檔案</strong></p>
<p><img src="/images/dp/dp-adapter/adapter012.svg" alt="adapter012"></p>
<p><strong>CloudSDK</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CloudSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 PhpStorm，從 <code>AWSSDK</code> 抽出 <code>CloudSDK</code> interface。</p>
<p>為了讓 <code>CloudStorageService</code> 封閉不要修改，我們希望 <code>CloudStorageService</code> 使用的 SDK 都能遵守 <code>CloudSDK</code> interface，如此 <code>CloudStorageService</code> 就能完全不用修改。</p>
<p><strong>CloudStorageService</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudStorageService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> CloudSDK */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cloudSDK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * CloudStorageService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudSDK = CloudSDKFactory::create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     * <span class="doctag">@param</span> string $localFile</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>, string <span class="variable">$localFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudSDK-&gt;pubObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>, <span class="variable">$localFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 下載檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileUrl</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;cloudSDK-&gt;getObjectUrl(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $folder</span><br><span class="line">     * <span class="doctag">@param</span> string $remoteFile</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteFile</span><span class="params">(string <span class="variable">$folder</span>, string <span class="variable">$remoteFile</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;cloudSDK-&gt;deleteObject(<span class="variable">$folder</span>, <span class="variable">$remoteFile</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> CloudSDK */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$cloudSDK</span>;</span><br></pre></td></tr></table></figure>
<p>透過重構的 <code>Rename</code>，將 <code>$awsSDK</code> 重構成 <code>$cloudSDK</code>，並將型別改成 <code>CloudSDK</code>。</p>
<p>8 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * CloudStorageService constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;cloudSDK = CloudSDKFactory::create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>new AWSSDK</code> 改成 <code>CloudSDKFactory::create()</code>，改由<strong>工廠</strong>來建立物件。</p>
<blockquote>
<p><strong>開放封閉原則</strong>規定我們不要修改 <code>CloudStorageService</code>，但 constructor 的修改是可接受的，但 method 內則不應該修改。</p>
</blockquote>
<p>至於 <code>CloudStorageService</code> 的其他部分則不修改，以達成<strong>開放封閉原則</strong>的要求。</p>
<p><strong>AWSAdapter</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">SDK</span>\<span class="title">AWSSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AWSAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AWSSDK */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$awsSDK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AWSAdapter constructor.</span><br><span class="line">     * <span class="doctag">@param</span> AWSSDK $awsSDK</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AWSSDK <span class="variable">$awsSDK</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK = <span class="variable">$awsSDK</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK-&gt;putObject(<span class="variable">$container</span>, <span class="variable">$blob</span>, <span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;awsSDK-&gt;getObject(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;awsSDK-&gt;deleteObject(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AWSAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span></span></span><br></pre></td></tr></table></figure>
<p>因為 <code>CloudSDK</code> interface 已經確定，因此我們需要一個 adapter 將 <code>CloudSDK</code> interface 轉成各 SDK 所定義的 interface。</p>
<p>由於 <code>CloudSDK</code> 是從 <code>AWSSDK</code> 抽出來的，因此 interface 完全一樣，<code>AWSAdapter</code> 只是將相同的 method 導到 <code>AWSSDK</code> 而已。</p>
<blockquote>
<p>這裡因為 <code>CloudSDK</code> interface 與 <code>AWSSDK</code> 完全一樣，所以暫時看不到 <code>CloudSDK</code> interface 的威力，稍後才會展現。</p>
</blockquote>
<p><strong>AzureAdapter</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">SDK</span>\<span class="title">AzureSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureSDK */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$azureSDK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureAdapter constructor.</span><br><span class="line">     * <span class="doctag">@param</span> AzureSDK $azureSDK</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AzureSDK <span class="variable">$azureSDK</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;azureSDK = <span class="variable">$azureSDK</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;azureSDK-&gt;createBlob(<span class="variable">$container</span>, <span class="variable">$blob</span>, <span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;getObjectUrl(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;deleteObject(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span></span></span><br></pre></td></tr></table></figure>
<p><code>AzureAdapter</code> 也實現 <code>CloudSDK</code> interface。</p>
<p>第 7 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> AzureSDK */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$azureSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * AzureAdapter constructor.</span><br><span class="line"> * <span class="doctag">@param</span> AzureSDK $azureSDK</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AzureSDK <span class="variable">$azureSDK</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;azureSDK = <span class="variable">$azureSDK</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依賴注入進 <code>AzureSDK</code>。</p>
<p>19 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 上傳檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@param</span> string $file</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;azureSDK-&gt;createBlob(<span class="variable">$container</span>, <span class="variable">$blob</span>, <span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>putObject()</code> 為 <code>CloudSDK</code> interface 所定義，所以一定要實作，轉而呼叫 <code>AzureSDK</code> 的 <code>createBlob()</code>。</p>
<p>30 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 回傳下載檔案 url</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@return</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;getObjectUrl(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getObjectUrl()</code> 為 <code>CloudSDK</code> interface 所定義，所以一定要實作，轉而呼叫 <code>AzureSDK</code> 的 <code>getObjetUrl()</code>。</p>
<p>41 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;deleteObject(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>deleteObject()</code> 為 <code>CloudSDK</code> interface 所定義，所以一定要實作，轉而呼叫 <code>AzureSDK</code>  的 <code>deleteObject()</code>。</p>
<blockquote>
<p>雖然 adapter 轉呼叫 <code>AzureSDK</code> 看似多餘，但由於實作了 <code>CloudSDK</code> interface，使得  <code>CloudStorageService</code> 不用修改就可以使用 <code>AzureSDK</code>，就類似 Macbook 不用改裝  VGA 介面，透過 adapter 就可以由 Mini Display 去使用 VGA 介面的投影機一樣，達成<strong>開放封閉原則</strong>的要求。</p>
</blockquote>
<p><strong>CloudSDKFactory</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudSDKFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span>: <span class="title">CloudSDK</span></span><br><span class="line">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CloudSDKFactory</code> 暫時只回傳 <code>CloudSDK</code> interface，至於要如何建立物件，我們最後再來實做。</p>
<p><strong>AzureSDK</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">SDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createBlob</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Azure Blob uploading file'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlobUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span>: <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'http://www.azure.com'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteBlob</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Azure Blob deleting file'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模擬 <code>AzureSDK</code> 的 API。</p>
<blockquote>
<p>對 <code>CloudStorageService</code> 而言，儘管 <code>AWSSDK</code> 與 <code>AzureSDK</code> 的 API 都不一樣，但已經將兩者抽象化為 <code>CloudSDK</code>，對 service 而言都是一樣的 SDK，只要透過 <code>AWSAdapter</code> 與  <code>AzureAdapter</code> 作轉換即可。</p>
<p>就類似僅管現在投影機有 VGA 也有 HDMI，對於 Macbook 而言都是 Mini Display Port，只要提供 VGA adapter 或 HDMI adapter 即可。</p>
</blockquote>
<h3 id="使用阿里雲_OSS">使用阿里雲 OSS</h3><p>雖然 Azure 提供很便宜的價格，但公司又擔心<strong>川普</strong>上台後，放在 Azure 的資料會被中國的<strong>網路長城</strong>封鎖，導致中國無法存取 Azure 檔案，因此高層決定將同一份程式，分別放到阿里雲與 Azure，相同網址，若在中國就使用阿里雲，其他國家使用 Azure。</p>
<p>阿里雲提供 OSS (Open Storage Service) 服務，功能與 AWS S3 與 Azure Blob 完全一樣，阿里雲也提供了 <code>Aliyun SDK for PHP</code> 供 PHP 使用。</p>
<p>阿里雲的 API 如下 (<code>AliyunSDK</code>)</p>
<table>
<thead>
<tr>
<th>功能描述</th>
<th>API</th>
</tr>
</thead>
<tbody>
<tr>
<td>上傳檔案</td>
<td>setBucket(＄container); uploadFile(＄blob, ＄file)</td>
</tr>
<tr>
<td>下載連結</td>
<td>setBucket(＄container); getUrl(＄blob)</td>
</tr>
<tr>
<td>刪除檔案</td>
<td>deleteObjet(＄container, ＄blob)</td>
</tr>
</tbody>
</table>
<p>目前 Azure 與阿里雲必須並存，AWS 暫時不用，但不能刪除，根據<strong>開放封閉原則</strong>，<code>AliyunSDK</code> 屬於新的需求，我們可以新增 class 支援 <code>AliyunSDK</code> (<strong><em>對擴展是開放的</em></strong>)，但不應該去修改原有 <code>CloudStorageService</code> (<strong><em>對修改是封閉的</em></strong>)。</p>
<p><img src="/images/dp/dp-adapter/adapter004.svg" alt="adapter004"></p>
<p><strong>上傳檔案</strong></p>
<p><img src="/images/dp/dp-adapter/adapter013.svg" alt="adapter013"></p>
<p><strong>AliyunAdapter</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">SDK</span>\<span class="title">AliyunSDK</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliyunAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AliyunSDK*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$aliyunSDK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AliyunAdapter constructor.</span><br><span class="line">     * <span class="doctag">@param</span> AliyunSDK $aliyunSDK</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AliyunSDK <span class="variable">$aliyunSDK</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;aliyunSDK = <span class="variable">$aliyunSDK</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 上傳檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@param</span> string $file</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;aliyunSDK-&gt;setBucket(<span class="variable">$container</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;aliyunSDK-&gt;uploadFile(<span class="variable">$blob</span>, <span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳下載檔案 url</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;aliyunSDK-&gt;setBucket(<span class="variable">$container</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;aliyunSDK-&gt;getUrl(<span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除檔案</span><br><span class="line">     * <span class="doctag">@param</span> string $container</span><br><span class="line">     * <span class="doctag">@param</span> string $blob</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;aliyunSDK-&gt;deleteObject(<span class="variable">$container</span>, <span class="variable">$blob</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>19 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 上傳檔案</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@param</span> string $file</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pubObject</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>, string <span class="variable">$file</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;aliyunSDK-&gt;setBucket(<span class="variable">$container</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;aliyunSDK-&gt;uploadFile(<span class="variable">$blob</span>, <span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>putObject()</code> 為 <code>CloudSDK</code> interface 所定義，所以一定要實作，因為 <code>AliyunSDK</code> 的 API 分兩步驟，需要先 <code>setBucket()</code>，然後再 <code>uploadFile()</code>。</p>
<p>31 行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 回傳下載檔案 url</span><br><span class="line"> * <span class="doctag">@param</span> string $container</span><br><span class="line"> * <span class="doctag">@param</span> string $blob</span><br><span class="line"> * <span class="doctag">@return</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getObjectUrl</span><span class="params">(string <span class="variable">$container</span>, string <span class="variable">$blob</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;aliyunSDK-&gt;setBucket(<span class="variable">$container</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;aliyunSDK-&gt;getUrl(<span class="variable">$blob</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getObjectUrl()</code> 為 <code>CloudSDK</code> interface 所定義，所以一定要實作，因為 <code>AliyunSDK</code> 的 API 分兩步驟，需要先 <code>setBucket()</code>，然後再 <code>getUrl()</code>。</p>
<p><strong>CloudFactory</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudSDKFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 建立 adapter</span><br><span class="line">     * <span class="doctag">@return</span> CloudSDK</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span>: <span class="title">CloudSDK</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$lut</span> = config(<span class="string">'app.CloudLUT'</span>);</span><br><span class="line">        <span class="variable">$cloudStorage</span> = config(<span class="string">'app.CloudStorage'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$className</span> = collect(<span class="variable">$lut</span>)</span><br><span class="line">            -&gt;get(<span class="variable">$cloudStorage</span>, AWSAdapter::class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$className</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$lut</code> 為工廠的對照表，紀錄什麼 key 該對應哪個 adapter。</p>
<p><code>$cloudStorage</code> 為目前該使用什麼 SDK，key 為 AWS、Azure 還是 Aliyun。</p>
<p>使用 Collection 根據 key 去抓 value，決定該 new 什麼 adapter。</p>
<blockquote>
<p>平常 service 不應該使用 <code>static</code>，但工廠是可用 <code>static</code> 的。</p>
</blockquote>
<p><strong>config/app.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'CloudLUT'</span> =&gt; [</span><br><span class="line">    <span class="string">'AWS'</span>    =&gt; AWSAdapter::class,</span><br><span class="line">    <span class="string">'Azure'</span>  =&gt; AzureAdapter::class,</span><br><span class="line">    <span class="string">'Aliyun'</span> =&gt; AliyunAdapter::class,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">'CloudStorage'</span> =&gt; <span class="string">'Azure'</span>,</span><br></pre></td></tr></table></figure>
<p><code>app.php</code> 為<strong>設定檔</strong>。</p>
<p><code>CloudLUT</code> 為 key / value 對照表，決定要 new 什麼 adapter。</p>
<p><code>CloudStorage</code> 決定目前主機要使用什麼雲端服務，這個檔案可以不放在 git，由 DevOps 去維護。</p>
<h2 id="開放封閉原則">開放封閉原則</h2><blockquote>
<p>對於擴展是開放的，對於修改是封閉的。</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>若有新的需求，可以增加程式碼，而不應該修改既有的程式碼。</p>
</blockquote>
<p>開了 <code>CloudSDK</code> interface 之後，之後雖然新增了 <code>AliyunSDK</code> 需求，我們只需要：</p>
<ul>
<li>新增 <code>AliyunAdapter</code> class。</li>
<li>新增 <code>app.php</code> 設定檔的 <code>CloudLUT</code> 。</li>
</ul>
<p>其他原本的程式碼完全沒修改。</p>
<p>整個程式碼沒看到一行的 <code>if else</code> 去切換 SDK，全部用物件導向的<strong>多型</strong>就可達成。</p>
<p>Interface 之前的 controller 與 service <strong>保持封閉</strong>，interface 之後的 adapter <strong>保持開放</strong>，達成<strong>開放封閉原則</strong>的要求。</p>
<h2 id="實務上的_Adapter">實務上的 Adapter</h2><p>我們可以發現使用 Adapter pattern 後，由於訂出 <code>Target</code> interface，可以針對不同的 <code>Adaptee</code> 擴充。</p>
<p>但所有設計模式都面臨一個最基本的問題 ：<strong>由誰決定根據 interface 所建立的物件</strong>，也就是該由誰決定 <code>Adapter</code>。</p>
<p><img src="/images/dp/dp-adapter/adapter005.svg" alt="adapter005"></p>
<p>實務上 Adapter pattern 都會搭配一個 Simple Factory pattern，由 factory 決定要使用哪一個 adapter。</p>
<h2 id="Adapter_的變形">Adapter 的變形</h2><p><img src="/images/dp/dp-adapter/adapter006.svg" alt="adapter006"></p>
<p><img src="/images/dp/dp-adapter/adapter014.svg" alt="adapter014"></p>
<p>Adapter 不限於只能搭配單一 Adaptee，實務上可以搭配多個 Adaptee，只要 Target interface 保持穩定即可。</p>
<h2 id="Conclusion">Conclusion</h2><ul>
<li><strong>資料結構</strong>相對於 C 語言的<strong>指標</strong>，就相當於<strong>設計模式</strong>相對於 <strong>interface</strong>；想學怎麼活用<strong>指標</strong>，就要去學<strong>資料結構</strong>，想學怎麼活用 <strong>interface</strong>，就要去學<strong>設計模式</strong>。</li>
<li><strong>Strategy</strong> + <strong>Simple Factory (依賴注入)</strong> 或 <strong>Adapter + Simple Factory (依賴注入)</strong> 是實務上<strong>最常</strong>用到的物件導向，學會這兩招，幾乎學會了 60% 的物件導向。</li>
<li>若會善用物件導向，程式碼的 <code>if else</code> 數量會降到最低，<strong>循環複雜度</strong>也會降到最低，會將原來該用 <code>if else</code> 改用 <code>interface</code>，用<strong>很多小檔案</strong>取代<strong>很長的檔案</strong>。</li>
<li>設計模式都會有些變形，不用在乎每本書講的設計模式都不太一樣，設計模式<strong>只重其意，不重其招</strong>，重點是搞懂設計模式所要解決問題的本質，就可以自行加以變形，靈活運用。</li>
</ul>
<p><img src="/images/dp/dp-adapter/adapter007.png" alt="adapter007"></p>
<p><img src="/images/dp/dp-adapter/adapter008.png" alt="adapter008"></p>
<p><img src="/images/dp/dp-adapter/adapter009.png" alt="adapter009"></p>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52Adapter_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/protractor/protractor-headless-chrome/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/protractor/protractor-shortcut/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-06-28 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Design-Pattern/">Design Pattern<span>17</span></a></li> <li><a href="/tags/Refactoring/">Refactoring<span>17</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
