<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何使用 TypeScript 實現 Chain Of Responsibility Pattern ? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="專門應付特殊場的 if else">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="專門應付特殊場的 if else">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 TypeScript 實現 Chain Of Responsibility Pattern ?">
<meta property="og:url" content="http://oomusou.io/design-pattern/cor/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="專門應付特殊場的 if else">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2018-03-19T01:47:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用 TypeScript 實現 Chain Of Responsibility Pattern ?">
<meta name="twitter:description" content="專門應付特殊場的 if else">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何使用 TypeScript 實現 Chain Of Responsibility Pattern ?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 專門應付特殊場的 if else			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#User_Story"><span class="toc-article-text">User Story</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Task"><span class="toc-article-text">Task</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Definition"><span class="toc-article-text">Definition</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Architecture"><span class="toc-article-text">Architecture</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Implemetation"><span class="toc-article-text">Implemetation</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#If_Else"><span class="toc-article-text">If Else</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Unit_Test"><span class="toc-article-text">Unit Test</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Default_Value"><span class="toc-article-text">Default Value</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Guard_Clause"><span class="toc-article-text">Guard Clause</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Chain_of_Responsibility"><span class="toc-article-text">Chain of Responsibility</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Refactoring"><span class="toc-article-text">Refactoring</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Functional_Way"><span class="toc-article-text">Functional Way</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Refactoring-1"><span class="toc-article-text">Refactoring</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Summary"><span class="toc-article-text">Summary</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>Chain of Responsibility 是 OOP 中著名的 Design Pattern，在特殊場合使用特別有效。在本文中，我們將以 Angular 與 TypeScript 實現。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS High Sierra 10.13.3<br>Node.js 8.9.4<br>Angular CLI 1.7.0<br>TypeScript 2.5.3<br>Angular 5.2.5<br>Wallaby.js 3.9.4</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/design-pattern/cor/cor000.png" alt="cor000"></p>
<ul>
<li>檢查 <code>產品編號</code></li>
<li>必須為 <code>整數</code>，<code>2</code> 的倍數與 <code>3</code> 的倍數才能傳回 <code>true</code>，否則均傳回 <code>false</code></li>
</ul>
<h2 id="Task">Task</h2><hr>
<p>先使用一般的寫法完成，最後再重構成 Chain of Responsbility。</p>
<h2 id="Definition">Definition</h2><blockquote>
<p>Chain of Responsibility Pattern</p>
<p>當多個物件都必須依序處理訊息，訂定統一個 interface，避免 client 與物件直接耦合<br>將 <code>外部 nested if</code> 改由 <code>外部決定</code> 的 <code>物件串列</code> 表示</p>
</blockquote>
<p><img src="/images/design-pattern/cor/cor007.svg" alt="cor007"></p>
<p><img src="/images/design-pattern/cor/cor006.svg" alt="cor006"></p>
<ul>
<li><strong>Client</strong> : <code>ConcreteHandler</code> 的 user，實務上可能是 component 或 service</li>
<li><strong>HandlerInterface</strong> : 定義 <code>ConcreteHandler</code> 的 interface</li>
<li><strong>AbstractHandler</strong> : 實作各 <code>ConcreteHandler</code> 共用的部分</li>
<li><strong>ConcreteHandler</strong> : 將 <code>if</code> 封裝成物件</li>
</ul>
<p>一個 <code>if</code> 放在一個 <code>ConcreteHandler</code> 物件內，當一個 <code>if</code> 判斷完後，就換下一個 <code>ConcreteHandler</code> 物件。</p>
<p>由於物件是串起來的，因此稱為 <code>Chain</code> of Responsibility。</p>
<p><strong>適用時機</strong></p>
<ul>
<li>深層 <code>nested if</code></li>
<li>須在 run-time 決定 <code>if</code> 組合</li>
<li><code>if</code> 層數不確定，由 run-time 決定</li>
</ul>
<p><strong>優點</strong></p>
<ul>
<li>每個 <code>if 判斷</code> 使用一個 class，符合 <code>單一職責原則</code></li>
<li>將來若有新的 <code>if 判斷</code>，不用修改 service，而是新增 <code>ConcreteHandler</code>，符合 <code>開放封閉原則</code></li>
<li>Client 與 <code>if 判斷</code> 解耦合，兩者都僅相依於 interface，符合 <code>依賴反轉原則</code></li>
<li><code>if</code> 邏輯物件化後，可在 run-time 自由組合與加入 <code>if</code> 物件 (組合 <code>ConcreteHandler</code>)</li>
</ul>
<p><strong>缺點</strong></p>
<ul>
<li>Chain 太長時會有效能問題</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/design-pattern/cor/cor001.svg" alt="cor001"></p>
<ul>
<li><code>AppComponent</code> 相當於 <code>Client</code></li>
<li><code>ProductNoChecker</code> 相當於 service，<code>AppComponent</code> 負責注入 <code>ProductNoChecker</code>，無論怎麼重構，<code>ProductNoChecker</code> 都是穩定的，不會導致 <code>AppComponent</code> 修改</li>
<li><code>CheckerInterface</code> 相當於 <code>HandlerInterface</code>，訂出所有 checker 的標準</li>
<li><code>AbstractChecker</code> 相當於 <code>AbstractHandler</code>，<code>nextChecker()</code> 相當於 <code>next()</code>，負責處理下一個 checker 部分</li>
<li><code>IntegerChecker</code> 相當於 <code>ConcreteHandler</code>，為實際 <code>if 判斷</code> 邏輯。</li>
</ul>
<h2 id="Implemetation">Implemetation</h2><hr>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> #<span class="attribute">productNo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onCheckProductNoClick()"</span>&gt;</span>Check ProductNo<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">&#123;&#123; result &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>若要在 JavaScript 存取 HTML，傳統會使用 <code>id</code> 或 CSS selector，在 Angular 提出新的方法，我們可以為 HTML 加上 <code>#</code> 開頭的 Template Reference Variable。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, ElementRef, ViewChild &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductNoChecker &#125; from <span class="string">'./checkers/product-no.checker'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  result: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  @ViewChild(<span class="string">'productNo'</span>)</span><br><span class="line">  <span class="keyword">private</span> productNoElement: ElementRef;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private productNoChecker: ProductNoChecker) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onCheckProductNoClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.productNoElement.nativeElement.value, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">this</span>.result = <span class="keyword">this</span>.productNoChecker.check(productNo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(<span class="string">'productNo'</span>)</span><br><span class="line"><span class="keyword">private</span> productNoElement: ElementRef;</span><br></pre></td></tr></table></figure>
<p>使用 <code>@ViewChild()</code> 取得 DOM element 的物件實體，參數以字串傳入 Template Reference Variable 的字串名稱。</p>
<p>注意其型別為 <code>ElementRef</code>。</p>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private productNoChecker: ProductNoChecker) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>ProductNoChecker</code> 透過 DI 注入進 <code>AppComponent</code>。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onCheckProductNoClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.productNoElement.nativeElement.value, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">this</span>.result = <span class="keyword">this</span>.productNoChecker.check(productNo);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>當按下 <code>&lt;button&gt;</code> 時，執行 <code>onCheckProductNoClick()</code>。</p>
<p>藉由 <code>@ViewChild()</code> 所宣告的變數，取得 DOM element 的值，因為為 string，再由 <code>parseInt()</code> 轉成 <code>integer</code>。</p>
<p>最後呼叫 <code>ProductNoChecker.check()</code>，判斷所輸入的 <code>ProductNo</code> 是否符合商業邏輯。</p>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;BrowserModule&#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ProductNoChecker&#125; from <span class="string">'./checkers/product-no.checker'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    ProductNoChecker</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  ProductNoChecker</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>在 <code>providers</code> 設定 <code>ProductNoChecker</code>，讓 DI 得以注入。</p>
<h3 id="If_Else">If Else</h3><p><strong>product-no.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ProductNoChecker &#123;</span><br><span class="line">  check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Number</span>.isInteger(productNo)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((productNo % <span class="number">2</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((productNo % <span class="number">3</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">          result = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          result = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於必須通過三層檢查，初學者很容易寫出三層的 <code>nested if</code>，這種寫法可讀性差也不好維護。</p>
<p>我們將繼續重構。</p>
<h3 id="Unit_Test">Unit Test</h3><p>在重構之前，必須要有測試保護，才能確保沒把原本的商業邏輯重構壞，因此我們先準備好 <code>ProductNoChecker</code> 的 Unit Test，確保每個 <code>if else</code> 的 path 都有測到。</p>
<p><strong>product-no.checker.spec.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; TestBed &#125; from <span class="string">'@angular/core/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductNoChecker &#125; from <span class="string">'./product-no.checker'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'ProductNoService'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> productNoChecker: ProductNoChecker;</span><br><span class="line"></span><br><span class="line">  beforeEach(() =&gt; &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      providers: [ProductNoChecker]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    productNoChecker = TestBed.get(ProductNoChecker);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should be created'</span>, () =&gt; &#123;</span><br><span class="line">    expect(productNoChecker).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'當ProductNo為整數，且為2與3的倍數，應回傳 true'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="number">6</span>;</span><br><span class="line">    expect(productNoChecker.check(productNo)).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'當ProductNo為整數，為2的倍數但不是3的倍數，應回傳 false'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="number">2</span>;</span><br><span class="line">    expect(productNoChecker.check(productNo)).toBeFalsy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'當ProductNo為整數，但不是2的倍數，應回傳 false'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="number">1</span>;</span><br><span class="line">    expect(productNoChecker.check(productNo)).toBeFalsy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'當ProductNo不是整數，應回傳 false'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> productNo = <span class="built_in">parseInt</span>(<span class="string">'t1'</span>, <span class="number">10</span>);</span><br><span class="line">    expect(productNoChecker.check(productNo)).toBeFalsy();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>由於本文重點不是在講 Unit Test，因此就不浪費篇幅解釋以上程式碼。</p>
<h3 id="Default_Value">Default Value</h3><p><strong>product-no.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ProductNoChecker &#123;</span><br><span class="line">  check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Number</span>.isInteger(productNo)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((productNo % <span class="number">2</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((productNo % <span class="number">3</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">          result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於整個 <code>nested if</code> 只有 三個 <code>if</code> 都成立時才是 <code>true</code>，其他都是 <code>false</code>，因此可以將 <code>result</code> 的預設值設定為 <code>false</code>，則所有的 else 都可拿掉。</p>
<p>但仍有三層 <code>nested if</code>，還是不夠好，我們將繼續重構。</p>
<h3 id="Guard_Clause">Guard Clause</h3><p><strong>product-no.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ProductNoChecker &#123;</span><br><span class="line">  check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(productNo)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (productNo % <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (productNo % <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Guard Clause</p>
<p>將 return false 的邏輯先處理，最後再來處理 return true，所有的 nested if 將攤平成只有一層</p>
</blockquote>
<p>先處理掉 <code>return false</code> 之後，剩下的事實上就是 <code>else</code>，因此就不需要 nested if 了。</p>
<blockquote>
<p>實務上推薦使用 Guard Clause，變免使用 nested if 與 else</p>
</blockquote>
<p><code>Nested if</code> 經過 Guard Clause 重構後，已經相當清爽了，但仍然還沒進入 OOP 層次，我們將繼續重構。</p>
<h3 id="Chain_of_Responsibility">Chain of Responsibility</h3><p><strong>CheckerInterface</strong></p>
<p><img src="/images/design-pattern/cor/cor002.svg" alt="cor002"></p>
<p><strong>checker.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> CheckerInterface </span>&#123;</span><br><span class="line">  setNextChecker(checker: CheckerInterface): CheckerInterface;</span><br><span class="line">  check(source: <span class="built_in">number</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們即將為每個 <code>if</code> 建立一個 class，先定義其 interface。</p>
<ul>
<li><code>setNextChecker()</code> : 由於每個 class 都是一個 <code>if</code> ，因此我們必須設定下一個 <code>if</code> 是哪一個 class 該檢查</li>
<li><code>check()</code> : 每個 class 寫 <code>if</code> 的地方</li>
</ul>
<p><strong>ProductNoChecker</strong></p>
<p><strong><img src="/images/design-pattern/cor/cor003.svg" alt="cor003">product-no.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IntegerChecker &#125; from <span class="string">'./integer.checker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CheckerInterface &#125; from <span class="string">'./checker.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DoubleChecker &#125; from <span class="string">'./double.checker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TripleChecker &#125; from <span class="string">'./triple.checker'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ProductNoChecker &#123;</span><br><span class="line">  check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> checker: CheckerInterface = <span class="keyword">new</span> IntegerChecker();</span><br><span class="line"></span><br><span class="line">    checker</span><br><span class="line">      .setNextChecker(<span class="keyword">new</span> DoubleChecker())</span><br><span class="line">      .setNextChecker(<span class="keyword">new</span> TripleChecker());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> checker.check(productNo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於我們是重構，且 <code>AppComponent</code> 所相依的是 <code>ProductNoChecker.check()</code>，因此 <code>check()</code> 的 signature 不應該修改。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> checker: CheckerInterface = <span class="keyword">new</span> IntegerChecker();</span><br><span class="line"></span><br><span class="line">  checker</span><br><span class="line">    .setNextChecker(<span class="keyword">new</span> DoubleChecker())</span><br><span class="line">    .setNextChecker(<span class="keyword">new</span> TripleChecker());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> checker.check(productNo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於 Chain of Responsibility 是一個 object 一個 object 依序檢查，因此只要先 new 第一個 <code>IntegerChecker</code> 即可，注意其型別為 <code>CheckerInterface</code>，這才符合 <code>依賴反轉原則</code>。</p>
<p>接下來必須使用 <code>setNextChecker()</code> 依序設定下一個 checker，這也是我們可以在 runtime 自由組合 <code>if 判斷</code> 的地方。</p>
<p>最後執行 <code>IntegerChecker.check()</code> 開始檢查 <code>ProductNo</code>。</p>
<blockquote>
<p>若是直接使用 <code>if</code>，則 <code>if</code> 將在 compile-time 就被決定無法更改，但使用 Chain of Responsibility 可以讓我們在 run-time 自行 <code>new</code> 決定是否使用這個 <code>if</code></p>
</blockquote>
<p><strong>AbstractChecker</strong></p>
<p><img src="/images/design-pattern/cor/cor004.svg" alt="cor004"></p>
<p><strong>abstract.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CheckerInterface &#125; from <span class="string">'./checker.interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> AbstractChecker <span class="keyword">implements</span> CheckerInterface &#123;</span><br><span class="line">  <span class="keyword">protected</span> nextChecker: CheckerInterface;</span><br><span class="line"></span><br><span class="line">  setNextChecker(checker: CheckerInterface): CheckerInterface &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.nextChecker = checker;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  abstract check(source: <span class="built_in">number</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>雖然 <code>CheckerInterface</code> 為每個 checker 都須具備的 interface，但其中的 <code>setNextChecker()</code> 顯然並不需要每個 checker 自己實踐，可將共用的部分交由 <code>AbstractChecker</code> 處理。</p>
<p>第 4 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> nextChecker: CheckerInterface;</span><br></pre></td></tr></table></figure>
<p>每個 checker 都必須紀錄下一個 checker 為何，因此特別宣告 <code>nextChecker</code> field。</p>
<p>由於將來繼承 <code>AbstractChecker</code> 的 class 都要使用，因此為 <code>protected</code> 。</p>
<p>注意其型別為 <code>CheckerInterface</code>。</p>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setNextChecker(checker: CheckerInterface): CheckerInterface &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.nextChecker = checker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本寫法為</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setNextChecker(checker: CheckerInterface): CheckerInterface &#123;</span><br><span class="line">  <span class="keyword">this</span>.nextChecker = checker;</span><br><span class="line">  <span class="keyword">return</span> checker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但可以將兩行併成一行完成。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abstract check(source: <span class="built_in">number</span>): <span class="built_in">boolean</span>;</span><br></pre></td></tr></table></figure>
<p><code>check()</code> 需要由各 class 的自行完成，因此 <code>AbstractChecker</code> 不實作，只設定成 <code>abstract</code> 交由所繼承的 class 完成。</p>
<p><strong>IntegerChecker</strong></p>
<p><img src="/images/design-pattern/cor/cor005.svg" alt="cor005"></p>
<p><strong>integer.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AbstractChecker &#125; from <span class="string">'./abstract.checker'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> IntegerChecker extends AbstractChecker &#123;</span><br><span class="line">  check(source: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(source)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.nextChecker) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.nextChecker.check(source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一樣使用 Guard Clause 的方式做判斷。</p>
<p>第 3 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> IntegerChecker extends AbstractChecker</span><br></pre></td></tr></table></figure>
<p><code>IntegerChecker</code> 也必須遵守 <code>CheckInterface</code>，因為 <code>AbstractChecker</code> 已經實現 <code>CheckerInterface</code>，所以 <code>IntegerChecker</code> 只要繼承 <code>AbstractChecker</code> 即可。</p>
<p>第 5 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(source)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若不是 <code>integer</code>，則 return <code>false</code>。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.nextChecker) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若沒有 <code>nextChecker</code> ，則表示為最後一個 checker，return <code>true</code>。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.nextChecker.check(source);</span><br></pre></td></tr></table></figure>
<p>若有 <code>nextChecker</code>，則執行下一個 cheker 繼續檢查。</p>
<p><code>DoubleChecker</code> 與 <code>TripleChecker</code> 的寫法類似，就不再贅述。</p>
<blockquote>
<p>目前為止，我們已經在 Angular 實現了經典的 Chain of Resposibility Pattern，但還可以對此 pattern 做小幅重構。</p>
</blockquote>
<h3 id="Refactoring">Refactoring</h3><p><strong>IntegerChecker</strong></p>
<p><img src="/images/design-pattern/cor/cor005.svg" alt="cor005"></p>
<p><strong>integer.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AbstractChecker &#125; from <span class="string">'./abstract.checker'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> IntegerChecker extends AbstractChecker &#123;</span><br><span class="line">  check(source: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="built_in">Number</span>.isInteger(source) ? <span class="literal">false</span> :</span><br><span class="line">           !<span class="keyword">this</span>.nextChecker ? <span class="literal">true</span> :</span><br><span class="line">           <span class="keyword">this</span>.nextChecker.check(source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 Guard Clause 寫法雖然已經非常精簡，但若使用 <code>?:</code>，則可寫出更精簡，且可讀性更高的寫法。</p>
<p><code>DoubleChecker</code> 與 <code>TripleChecker</code> 的寫法類似，就不再贅述。</p>
<h3 id="Functional_Way">Functional Way</h3><p>Chain of Responsibility 雖然是 OOP 的 Design Pattern，但亦可使用 FP 實踐。</p>
<p><strong>checker.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> CheckerInterface </span>&#123;</span><br><span class="line">  (source: <span class="built_in">number</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前 <code>CheckerInterface</code> 雖然定義了 <code>setNextChecker()</code> 與 <code>check()</code> 兩個 method，但平心而論，只有 <code>check()</code> 才是真的 <code>if</code> 所要用的 method，<code>setNextChecker()</code> 算是 pattern 本身所使用的 method。</p>
<p>也就是說若我們能將 class interface 退化成 function interface，只描述 <code>check()</code> 的 signature，則 Chain of Responsibility 不一定得用 class 才能實踐，只要 function 即可。</p>
<p> TypeScript 的 interface 可以只描述 function 規格 :</p>
<ul>
<li>Input 以 <code>()</code> 表示</li>
<li>沒有 function name</li>
<li>Return 寫在 <code>:</code> 之後</li>
</ul>
<blockquote>
<p>TypeScript 的 interface 不再只是描述 class 的規格，也可以描述 function 的規格</p>
</blockquote>
<p><strong>integer.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">checkInteger</span>(<span class="params">source: <span class="built_in">number</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Number</span>.isInteger(source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>integer.checker.ts</code> 不用再使用 class，使用 function 即可，當然要符合 <code>checker.interface.ts</code> 的規格。</p>
<blockquote>
<p>我們可發現 FP 版本的 <code>checkInteger()</code> 甚至不用判斷 <code>nextChecker()</code>，專心的判斷 <code>isInteger()</code> 即可，比 OOP 版更加符合 <code>單一職責原則</code></p>
</blockquote>
<p><strong>product-no.checker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CheckerInterface &#125; from <span class="string">'./checker.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; integerCheck &#125; from <span class="string">'./integer.checker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; doubleCheck &#125; from <span class="string">'./double.checker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tripleCheck &#125; from <span class="string">'./triple.checker'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ProductNoChecker &#123;</span><br><span class="line">  <span class="keyword">private</span> checkers: CheckerInterface[];</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.checkers = [</span><br><span class="line">      checkInteger,</span><br><span class="line">      checkDouble,</span><br><span class="line">      checkTriple</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.checkers.every(checker =&gt; checker(productNo));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkers: CheckerInterface[];</span><br></pre></td></tr></table></figure>
<p>存放所有 checker function 的陣列，別忘了之前已經定義了 <code>CheckerInterface</code> 的 function interface，在此更可描述 <code>checkers</code> 陣列所放的全部都是 <code>CheckerInterface</code> 的 function，除此之外，TypeScript 編譯器也會加以檢查，若function 不符合 <code>CheckerInterface</code> 規格，將編譯錯誤。</p>
<blockquote>
<p>儘管使用了 FP，一樣要使用 interface，才能受到編譯器的保護</p>
</blockquote>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.checkers = [</span><br><span class="line">    checkInteger,</span><br><span class="line">    checkDouble,</span><br><span class="line">    checkTriple</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>checkers</code> 陣列該含有哪些 checker function，類似 OOP 版的 <code>setNextChecker()</code>。</p>
<blockquote>
<p>若這些 checker function 需經常變動，還可以將 <code>checkers</code> 放在 config 檔，且 checker function 還受到 TypeScript 編譯器保護，符合 <code>開放封閉原則</code></p>
</blockquote>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.checkers.every(checker =&gt; checker(productNo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>every()</code> 為 JavaScript 提供的 array method，將會執行 array 內所有的 function，若其中任何一個 function 回傳 <code>false</code>，則回傳 <code>false</code>，必須全部 function 回傳 <code>true</code> 時，才會回傳 <code>true</code>，與 OOP 版的 Chain of Responsibility 有異曲同工之妙。</p>
<blockquote>
<p>OOP  版當然也可以使用陣列內放 <code>ConcreteHandler</code> 方式，不過由於沒有 FP 版精妙，因此不特別說明</p>
</blockquote>
<h3 id="Refactoring-1">Refactoring</h3><p>原本 OOP 版是只要回傳 <code>false</code>，就不會執行下一個 object；但 <code>Array.every()</code> 卻要求我們執行所有的 function，所以效能較差。</p>
<p>JavaScript 原生提供了 <code>Array.some()</code>，只要回傳 <code>true</code>，就不會執行下一個 function，跟我們的需求很類似，但又不完全一樣，因此只好自己打造 <code>Array.any()</code>。</p>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">check(productNo: <span class="built_in">number</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="built_in">Array</span>.prototype.any = <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.some(item =&gt; !fn(item));</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.checkers.any(checker =&gt; checker(productNo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於 <code>Array.some()</code> 是判斷 <code>true</code>，所以須將 <code>fn(item)</code> 加上 <code>!</code> 反向迎合 <code>some()</code>，但最後 <code>this.som()</code> 還必須再加上 <code>!</code> 還原真實狀況。</p>
<p>使用 prototype 打造了自己的 <code>any()</code> 之後，就不用擔心 <code>every()</code> 影響效能了。</p>
<h2 id="Summary">Summary</h2><hr>
<ul>
<li>FP 版的 <code>checkers</code> 陣列甚至可以改寫在 config 檔案，彈性比 OOP 更大</li>
<li>FP 也要使用 interface，這樣編譯器才能幫你做檢查</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>並不是所有的 <code>if</code> 判斷都該使用 Chain of Responsibility，當特別深層的 <code>nested if</code>，或需要 runtime 自由組合 <code>if 判斷</code> ，或 <code>if</code> 層數不確定時，就適合使用</li>
<li>FP 的出現，讓 Design Pattern 的實踐方式，不再只有 OOP 一途，可視實際需求決定該使用 OOP 或 FP</li>
<li>無論是 OOP 或 FP，最終都是符合 SOLID 的 <code>開放封閉原則</code> 與 <code>依賴反轉原則</code>，通常 FP 的實踐都會比 OOP 更精簡</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52CoR" target="_blank" rel="external">GitHub</a> 上找到</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/fsharp/setup/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/typescript/interface/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-02-21 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Angular/">Angular<span>47</span></a></li> <li><a href="/tags/Design-Pattern/">Design Pattern<span>17</span></a></li> <li><a href="/tags/TypeScript/">TypeScript<span>23</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
